<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tanki Online Music</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;500;700&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            --md-sys-color-background: #001926;
            --md-sys-color-on-background: #BFD5FF;
            --md-sys-color-primary: #76FF33;
            --md-sys-color-on-primary: #001926;
            --md-sys-color-surface-container: rgba(191, 213, 255, 0.05);
            --md-sys-color-surface-container-high: rgba(191, 213, 255, 0.10);
            --md-sys-color-secondary-text: rgba(191, 213, 255, 0.6);
            
            --font-stack: 'Rubik', 'M PLUS 1p', sans-serif;
            --md-sys-shape-corner: 24px;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        html, body { width: 100%; max-width: 100vw; margin: 0; padding: 0; overflow-x: hidden; }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: var(--font-stack);
            padding: 24px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: var(--font-stack);
            font-size: 3rem; font-weight: 700;
            color: var(--md-sys-color-primary);
            margin: 30px 0 50px 0; text-align: center; line-height: 1.1;
            text-shadow: 0 0 20px rgba(118, 255, 51, 0.2); padding: 0 10px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px;
        }

        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner);
            padding: 20px;
            display: flex; flex-direction: column;
            gap: 12px; 
            border: 1px solid rgba(191, 213, 255, 0.05);
            transition: background-color 0.2s;
            width: 100%;
            justify-content: center;
            position: relative;
        }

        .card:hover {
            background-color: var(--md-sys-color-surface-container-high);
            border-color: rgba(118, 255, 51, 0.2);
        }

        .track-info {
            display: flex; flex-direction: column; gap: 4px;
            margin-bottom: 4px; min-height: 32px; justify-content: center;
        }

        .track-title {
            font-family: var(--font-stack); font-size: 1.25rem; font-weight: 500;
            margin: 0; color: var(--md-sys-color-on-background);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3;
        }

        .track-artist {
            font-family: var(--font-stack); font-size: 0.9rem; font-weight: 400;
            color: var(--md-sys-color-secondary-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 歌词区域 */
        .lyrics-display {
            font-family: var(--font-stack);
            font-size: 1rem;
            color: var(--md-sys-color-primary);
            text-align: center;
            height: 3.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            line-height: 1.4;
            overflow: hidden;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(118, 255, 51, 0.3);
            margin-bottom: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lyrics-display.active {
            opacity: 1;
        }

        .placeholder-icon {
            font-size: 24px;
            opacity: 0.7;
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.9); opacity: 0.4; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        /* 加载动画 */
        .loading-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }

        .player-ui { display: flex; align-items: center; gap: 10px; width: 100%; }

        .play-btn {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; outline: none;
            transition: transform 0.1s;
        }
        .play-btn:active { transform: scale(0.95); }
        .play-btn .material-symbols-rounded { font-size: 28px; }

        .download-btn {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--md-sys-color-on-background); text-decoration: none;
            opacity: 0.6; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .download-btn:active { background-color: rgba(255,255,255,0.1); }
        .download-btn .material-symbols-rounded { font-size: 20px; }

        .controls-area {
            flex-grow: 1; display: flex; flex-direction: column;
            gap: 4px; min-width: 0; padding: 0 4px;
        }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: rgba(191, 213, 255, 0.2); border-radius: 2px;
            outline: none; margin: 0; display: block;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: var(--md-sys-color-primary); border-radius: 50%;
            box-shadow: 0 0 8px rgba(118, 255, 51, 0.5); border: none;
        }

        .time-display {
            font-family: var(--font-stack); font-size: 0.7rem;
            color: var(--md-sys-color-on-background); opacity: 0.7;
            text-align: right; font-variant-numeric: tabular-nums; margin-right: 2px;
        }

        @media (max-width: 600px) {
            body { padding: 12px; }
            h1 { font-size: 2.2rem; margin: 20px 0 30px 0; }
            .grid-container { display: flex; flex-direction: column; gap: 12px; }
            .card { padding: 16px; gap: 12px; width: 100%; }
            .player-ui { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <h1 id="page-title">Tanki Online Music</h1>
    <div class="grid-container" id="music-container"></div>

    <script>
        const musicBaseUrl = "https://testanki1.github.io/music/";
        
        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    const msStr = match[3];
                    let ms = parseInt(msStr, 10);
                    if (msStr.length === 2) ms = ms * 10;
                    else if (msStr.length === 1) ms = ms * 100;
                    const totalSeconds = minutes * 60 + seconds + (ms / 1000);
                    const content = line.replace(timeReg, '').trim();
                    result.push({ time: totalSeconds, text: content });
                }
            });
            return result;
        }

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        // 状态变量
        let currentSource = null;    
        let currentBuffer = null;    
        let startAt = 0;             
        let pauseAt = 0;             
        let isPlaying = false;
        
        // --- 关键修改：用于解决竞争的变量 ---
        let activeCardId = null;       // 当前正在播放（或已暂停）的卡片ID
        let loadingTargetId = null;    // 当前正在等待加载的卡片ID
        
        let animationFrameId = null; 
        const bufferCache = {};
        const lrcCache = {};

        const musicList = [
            { zh: "3D坦克", en: "Tanki Online", artist: null, file: "tankionline.mp3" },
            { zh: "3D坦克 2", en: "Tanki Online 2", artist: null, file: "tankionline2.mp3" },
            { zh: "3D坦克 1.2", en: "Tanki Online 1.2", artist: null, file: "Tanki_Online-Soundtrack.mp3" },
            { zh: "3D坦克 X", en: "Tanki X", artist: null, file: "Tanki X – Official Soundtrack.mp3" },
            { zh: "史诗", en: "Epic", artist: null, file: "TankiOnline_Ringtone_Epic.mp3" },
            { zh: "神秘", en: "Mysterious", artist: null, file: "TankiOnline_Ringtone_Mysterious.mp3" },
            { zh: "英勇", en: "Heroic", artist: null, file: "TankiOnline_Ringtone_Heroic.mp3" },
            { zh: "主要", en: "Main Theme", artist: null, file: "TankiOnline_Ringtone_Main.mp3" },
            { zh: "8 位", en: "8-bit", artist: "Pago", file: "TankiOnline_Ringtone_8bit.mp3" },
            { zh: "3D坦克新年主题", en: "Tanki Online New Year Theme", artist: "Vospi", file: "Vospi - Tanki Online New Year Theme.mp3" },
            { zh: "3D坦克暗物质主题", en: "Tanki Online Dark Matter Theme", artist: "Vospi", file: "Vospi - Tanki Online Dark Matter Theme.mp3" },
            { zh: "Bounce（赛博坦克主题）", en: "Bounce (CyberTank Theme)", artist: "Vospi", file: "Vospi - Bounce.mp3", lrc: "Vospi - Bounce.lrc" },
            { zh: "专家战场", en: "PRO Battles", artist: null, file: "pro_battles.mp3" },
            { zh: "专家战场限制", en: "PRO Battles Limit", artist: null, file: "pro_battles_limit.mp3" },
            { zh: "商店环境音", en: "Shop Ambience", artist: null, file: "ambient_shop.mp3" },
            { zh: "疯狂思维空间", en: "Madness", artist: null, file: "madness.mp3" },
            { zh: "万圣节环境音", en: "Halloween Ambience", artist: null, file: "halloween_ambience.mp3" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const lang = navigator.language || navigator.userLanguage; 
            const isChinese = lang.toLowerCase().startsWith('zh');
            
            const mainTitle = document.getElementById('page-title');
            const titleText = isChinese ? "3D坦克音乐" : "Tanki Online Music";
            document.title = titleText;
            mainTitle.textContent = titleText;

            const container = document.getElementById('music-container');
            
            musicList.forEach((item, index) => {
                const fileId = `track-${index}`;
                const fullUrl = musicBaseUrl + item.file;
                const displayName = isChinese ? item.zh : item.en;
                const artistHtml = item.artist ? `<div class="track-artist">${item.artist}</div>` : '';
                const lrcHtml = item.lrc ? `<div class="lyrics-display" id="lyrics-${fileId}"></div>` : '';

                const card = document.createElement('div');
                card.className = 'card';
                card.id = fileId;
                
                card.innerHTML = `
                    <div class="track-info">
                        <div class="track-title">${displayName}</div>
                        ${artistHtml}
                    </div>
                    ${lrcHtml}
                    <div class="player-ui">
                        <button class="play-btn" data-url="${fullUrl}" data-id="${fileId}">
                            <span class="material-symbols-rounded">play_arrow</span>
                        </button>
                        <div class="controls-area">
                            <input type="range" class="seek-slider" min="0" max="100" value="0" step="0.1">
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                        <a href="${fullUrl}" download class="download-btn" title="Download">
                            <span class="material-symbols-rounded">download</span>
                        </a>
                    </div>
                `;
                container.appendChild(card);
                
                if (item.lrc) {
                    fetch(musicBaseUrl + item.lrc)
                        .then(r => r.text())
                        .then(text => { lrcCache[fileId] = parseLRC(text); })
                        .catch(e => console.error("LRC Error", e));
                }

                const btn = card.querySelector('.play-btn');
                const range = card.querySelector('.seek-slider');

                btn.addEventListener('click', () => handlePlayClick(btn, fullUrl, fileId));
                
                range.addEventListener('input', () => {
                    if (activeCardId === fileId && currentBuffer) {
                        updateRangeBackground(range);
                        const seekTime = (range.value / 100) * currentBuffer.duration;
                        playAudio(currentBuffer, seekTime); 
                    }
                });
            });
        });

        async function handlePlayClick(btn, url, fileId) {
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            // 情况1：点击正在加载中的按钮 -> 取消加载
            if (loadingTargetId === fileId) {
                loadingTargetId = null; // 取消标记
                setLoadingState(btn, false);
                return;
            }

            // 情况2：点击当前正在播放/暂停的歌曲 -> 切换播放状态
            if (activeCardId === fileId && loadingTargetId === null) {
                if (isPlaying) {
                    pauseAudio();
                } else {
                    playAudio(currentBuffer, pauseAt);
                }
                return;
            }

            // 情况3：点击了一首新歌
            
            // 如果之前有正在加载的，先重置它的UI
            if (loadingTargetId) {
                const prevLoadingCard = document.getElementById(loadingTargetId);
                if (prevLoadingCard) {
                    setLoadingState(prevLoadingCard.querySelector('.play-btn'), false);
                }
            }

            // 停止当前播放的
            stopAudio();
            resetUI(activeCardId);
            
            // 设置新的加载目标
            activeCardId = null; // 在加载完成前，没有 active
            loadingTargetId = fileId;
            setLoadingState(btn, true);

            try {
                // 检查缓存
                let audioBuffer;
                if (bufferCache[url]) {
                    audioBuffer = bufferCache[url];
                } else {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    bufferCache[url] = audioBuffer;
                }
                
                // --- 关键检查：加载完成后，用户是否还想听这首？---
                if (loadingTargetId !== fileId) {
                    // 用户在加载过程中点了别的，或者取消了
                    return; // 退出，不播放
                }

                // 加载成功且用户未取消
                currentBuffer = audioBuffer;
                activeCardId = fileId; 
                loadingTargetId = null; // 加载完成
                setLoadingState(btn, false);
                playAudio(currentBuffer, 0);

            } catch (err) {
                if (loadingTargetId === fileId) {
                    console.error("Load failed:", err);
                    setLoadingState(btn, false);
                    loadingTargetId = null;
                    alert("Loading failed or aborted.");
                }
            }
        }

        function playAudio(buffer, offset) {
            if (currentSource) {
                currentSource.stop();
                currentSource = null;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            source.connect(audioCtx.destination);
            
            startAt = audioCtx.currentTime - offset;
            pauseAt = offset;
            
            source.start(0, offset % buffer.duration);
            currentSource = source;
            isPlaying = true;

            updatePlayIcon(activeCardId, 'pause');
            
            if (!animationFrameId) renderLoop();
        }

        function pauseAudio() {
            if (currentSource) {
                currentSource.stop();
                currentSource = null;
            }
            pauseAt = (audioCtx.currentTime - startAt) % currentBuffer.duration;
            isPlaying = false;
            updatePlayIcon(activeCardId, 'play_arrow');
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        function stopAudio() {
            if (currentSource) {
                currentSource.stop();
                currentSource = null;
            }
            isPlaying = false;
            pauseAt = 0;
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        function renderLoop() {
            if (!isPlaying || !activeCardId || !currentBuffer) return;

            const elapsed = audioCtx.currentTime - startAt;
            const currentTime = elapsed % currentBuffer.duration;
            const duration = currentBuffer.duration;

            const card = document.getElementById(activeCardId);
            if (!card) return;

            const range = card.querySelector('.seek-slider');
            const timeDisplay = card.querySelector('.time-display');
            const lyricsDiv = card.querySelector('.lyrics-display');

            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;

            if (document.activeElement !== range) {
                range.value = (currentTime / duration) * 100;
                updateRangeBackground(range);
            }

            if (lyricsDiv && lrcCache[activeCardId]) {
                const lrcData = lrcCache[activeCardId];
                let currentLineText = "";
                
                for (let i = 0; i < lrcData.length; i++) {
                    if (lrcData[i].time <= currentTime) {
                        currentLineText = lrcData[i].text;
                    } else {
                        break;
                    }
                }

                if (currentLineText && currentLineText.trim() !== "") {
                    lyricsDiv.textContent = currentLineText;
                    lyricsDiv.classList.add('active');
                    const icon = lyricsDiv.querySelector('.placeholder-icon');
                    if(icon) icon.remove();
                } else {
                    if(lyricsDiv.textContent.trim() === "" || lyricsDiv.querySelector('.placeholder-icon')) {
                         if (!lyricsDiv.querySelector('.placeholder-icon')) {
                            lyricsDiv.innerHTML = '<span class="material-symbols-rounded placeholder-icon">music_note</span>';
                        }
                        lyricsDiv.classList.add('active');
                    }
                }
            }

            animationFrameId = requestAnimationFrame(renderLoop);
        }

        function setLoadingState(btn, isLoading) {
            const icon = btn.querySelector('span');
            if (isLoading) {
                // 使用 sync 图标代替 refresh，看起来更像缓冲
                icon.textContent = 'sync'; 
                icon.classList.add('loading-icon');
                btn.style.opacity = '0.7';
            } else {
                icon.classList.remove('loading-icon');
                btn.style.opacity = '1';
                // 恢复图标由 updatePlayIcon 或 resetUI 处理
                // 如果是取消加载，这里需要手动恢复 play_arrow
                if (!isPlaying) icon.textContent = 'play_arrow';
            }
        }

        function updatePlayIcon(id, iconName) {
            if (!id) return;
            const card = document.getElementById(id);
            const icon = card.querySelector('.play-btn span');
            icon.textContent = iconName;
            icon.classList.remove('loading-icon');
        }

        function resetUI(id) {
            if (!id) return;
            const card = document.getElementById(id);
            const range = card.querySelector('.seek-slider');
            const timeDisplay = card.querySelector('.time-display');
            const icon = card.querySelector('.play-btn span');
            const lyricsDiv = card.querySelector('.lyrics-display');

            icon.textContent = 'play_arrow';
            icon.classList.remove('loading-icon');
            range.value = 0;
            updateRangeBackground(range);
            timeDisplay.textContent = "0:00 / 0:00";
            if(lyricsDiv) lyricsDiv.classList.remove('active');
        }

        function updateRangeBackground(input) {
            const value = input.value;
            input.style.background = `linear-gradient(to right, #76FF33 0%, #76FF33 ${value}%, rgba(191, 213, 255, 0.2) ${value}%, rgba(191, 213, 255, 0.2) 100%)`;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    </script>
</body>
</html>
