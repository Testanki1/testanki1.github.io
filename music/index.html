<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tanki Online Music</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;500;700&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            --md-sys-color-background: #001926;
            --md-sys-color-on-background: #BFD5FF;
            --md-sys-color-primary: #76FF33;
            --md-sys-color-on-primary: #001926;
            --md-sys-color-surface-container: rgba(191, 213, 255, 0.05);
            --md-sys-color-surface-container-high: rgba(191, 213, 255, 0.10);
            --md-sys-color-secondary-text: rgba(191, 213, 255, 0.6);
            
            --font-stack: 'Rubik', 'M PLUS 1p', sans-serif;
            --md-sys-shape-corner: 24px;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        html, body { width: 100%; max-width: 100vw; margin: 0; padding: 0; overflow-x: hidden; }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: var(--font-stack);
            padding: 24px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: var(--font-stack);
            font-size: 3rem; font-weight: 700;
            color: var(--md-sys-color-primary);
            margin: 30px 0 50px 0; text-align: center; line-height: 1.1;
            text-shadow: 0 0 20px rgba(118, 255, 51, 0.2); padding: 0 10px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px;
        }

        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner);
            padding: 20px;
            display: flex; flex-direction: column;
            gap: 12px; 
            border: 1px solid rgba(191, 213, 255, 0.05);
            transition: background-color 0.2s;
            width: 100%;
            justify-content: center;
            position: relative;
        }

        .card:hover {
            background-color: var(--md-sys-color-surface-container-high);
            border-color: rgba(118, 255, 51, 0.2);
        }

        .track-info {
            display: flex; flex-direction: column; gap: 4px;
            margin-bottom: 4px; min-height: 32px; justify-content: center;
        }

        .track-title {
            font-family: var(--font-stack); font-size: 1.25rem; font-weight: 500;
            margin: 0; color: var(--md-sys-color-on-background);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3;
        }

        .track-artist {
            font-family: var(--font-stack); font-size: 0.9rem; font-weight: 400;
            color: var(--md-sys-color-secondary-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 歌词区域 */
        .lyrics-display {
            font-family: var(--font-stack);
            font-size: 1rem;
            color: var(--md-sys-color-primary);
            text-align: center;
            height: 3.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            line-height: 1.4;
            overflow: hidden;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(118, 255, 51, 0.3);
            margin-bottom: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lyrics-display.active {
            opacity: 1;
        }

        .placeholder-icon {
            font-size: 24px;
            opacity: 0.7;
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.9); opacity: 0.4; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        .player-ui { display: flex; align-items: center; gap: 10px; width: 100%; }

        .play-btn {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; outline: none;
        }
        .play-btn .material-symbols-rounded { font-size: 28px; }

        .download-btn {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--md-sys-color-on-background); text-decoration: none;
            opacity: 0.6; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .download-btn:active { background-color: rgba(255,255,255,0.1); }
        .download-btn .material-symbols-rounded { font-size: 20px; }

        .controls-area {
            flex-grow: 1; display: flex; flex-direction: column;
            gap: 4px; min-width: 0; padding: 0 4px;
        }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: rgba(191, 213, 255, 0.2); border-radius: 2px;
            outline: none; margin: 0; display: block;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: var(--md-sys-color-primary); border-radius: 50%;
            box-shadow: 0 0 8px rgba(118, 255, 51, 0.5); border: none;
        }

        .time-display {
            font-family: var(--font-stack); font-size: 0.7rem;
            color: var(--md-sys-color-on-background); opacity: 0.7;
            text-align: right; font-variant-numeric: tabular-nums; margin-right: 2px;
        }

        audio { display: none; }

        @media (max-width: 600px) {
            body { padding: 12px; }
            h1 { font-size: 2.2rem; margin: 20px 0 30px 0; }
            .grid-container { display: flex; flex-direction: column; gap: 12px; }
            .card { padding: 16px; gap: 12px; width: 100%; }
            .player-ui { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <h1 id="page-title">Tanki Online Music</h1>
    
    <div class="grid-container" id="music-container"></div>

    <script>
        const musicBaseUrl = "https://testanki1.github.io/music/";
        
        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;

            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    
                    const msStr = match[3];
                    let ms = parseInt(msStr, 10);

                    if (msStr.length === 2) {
                        ms = ms * 10; 
                    } else if (msStr.length === 1) {
                        ms = ms * 100;
                    }

                    const totalSeconds = minutes * 60 + seconds + (ms / 1000);
                    const content = line.replace(timeReg, '').trim();
                    result.push({ time: totalSeconds, text: content });
                }
            });
            return result;
        }

        const musicList = [
            { zh: "3D坦克", en: "Tanki Online", artist: null, file: "tankionline.mp3" },
            { zh: "3D坦克 2", en: "Tanki Online 2", artist: null, file: "tankionline2.mp3" },
            { zh: "3D坦克 1.2", en: "Tanki Online 1.2", artist: null, file: "Tanki_Online-Soundtrack.mp3" },
            { zh: "3D坦克 X", en: "Tanki X", artist: null, file: "Tanki X – Official Soundtrack.mp3" },
            { zh: "史诗", en: "Epic", artist: null, file: "TankiOnline_Ringtone_Epic.mp3" },
            { zh: "神秘", en: "Mysterious", artist: null, file: "TankiOnline_Ringtone_Mysterious.mp3" },
            { zh: "英勇", en: "Heroic", artist: null, file: "TankiOnline_Ringtone_Heroic.mp3" },
            { zh: "主要", en: "Main Theme", artist: null, file: "TankiOnline_Ringtone_Main.mp3" },
            
            { zh: "8 位", en: "8-bit", artist: "Pago", file: "TankiOnline_Ringtone_8bit.mp3" },
            { zh: "3D坦克新年主题", en: "Tanki Online New Year Theme", artist: "Vospi", file: "Vospi - Tanki Online New Year Theme.mp3" },
            { zh: "3D坦克暗物质主题", en: "Tanki Online Dark Matter Theme", artist: "Vospi", file: "Vospi - Tanki Online Dark Matter Theme.mp3" },
            
            { 
                zh: "Bounce（赛博坦克主题）", 
                en: "Bounce (CyberTank Theme)", 
                artist: "Vospi", 
                file: "Vospi - Bounce.mp3",
                lrc: "Vospi - Bounce.lrc" 
            },
            
            { zh: "专家战场", en: "PRO Battles", artist: null, file: "pro_battles.mp3" },
            { zh: "专家战场限制", en: "PRO Battles Limit", artist: null, file: "pro_battles_limit.mp3" },
            { zh: "商店环境音", en: "Shop Ambience", artist: null, file: "ambient_shop.mp3" },
            { zh: "疯狂思维空间", en: "Madness", artist: null, file: "madness.mp3" },
            { zh: "万圣节环境音", en: "Halloween Ambience", artist: null, file: "halloween_ambience.mp3" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const lang = navigator.language || navigator.userLanguage; 
            const isChinese = lang.toLowerCase().startsWith('zh');
            
            const mainTitle = document.getElementById('page-title');
            const titleText = isChinese ? "3D坦克音乐" : "Tanki Online Music";
            document.title = titleText;
            mainTitle.textContent = titleText;

            const container = document.getElementById('music-container');
            
            musicList.forEach(item => {
                const fullUrl = musicBaseUrl + item.file;
                const displayName = isChinese ? item.zh : item.en;
                const artistHtml = item.artist ? `<div class="track-artist">${item.artist}</div>` : '';
                const lrcHtml = item.lrc ? `<div class="lyrics-display" id="lyrics-${item.file.replace(/[^a-zA-Z0-9]/g, '')}"></div>` : '';

                const card = document.createElement('div');
                card.className = 'card';
                
                card.innerHTML = `
                    <div class="track-info">
                        <div class="track-title">${displayName}</div>
                        ${artistHtml}
                    </div>
                    ${lrcHtml}
                    <div class="player-ui">
                        <button class="play-btn"><span class="material-symbols-rounded">play_arrow</span></button>
                        <div class="controls-area">
                            <input type="range" min="0" max="100" value="0" step="0.1">
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                        <a href="${fullUrl}" download class="download-btn" title="Download">
                            <span class="material-symbols-rounded">download</span>
                        </a>
                        <audio loop src="${fullUrl}" preload="metadata"></audio>
                    </div>
                `;
                container.appendChild(card);
                
                if (item.lrc) {
                    const lrcUrl = musicBaseUrl + item.lrc;
                    const audio = card.querySelector('audio');
                    
                    fetch(lrcUrl)
                        .then(response => {
                            if (!response.ok) throw new Error("LRC load failed");
                            return response.text();
                        })
                        .then(text => {
                            audio.lrcData = parseLRC(text);
                        })
                        .catch(err => console.log('No lyrics found for', item.file));
                }
            });

            const players = document.querySelectorAll('.player-ui');
            const allAudios = document.querySelectorAll('audio');

            players.forEach(player => {
                const audio = player.querySelector('audio');
                const btn = player.querySelector('.play-btn');
                const icon = btn.querySelector('span');
                const range = player.querySelector('input[type="range"]');
                const timeDisplay = player.querySelector('.time-display');
                const lyricsDiv = player.parentElement.querySelector('.lyrics-display');
                
                // 用于存储 requestAnimationFrame 的 ID，以便停止循环
                let animationFrameId;

                function formatTime(seconds) {
                    if (isNaN(seconds)) return "0:00";
                    const m = Math.floor(seconds / 60);
                    const s = Math.floor(seconds % 60);
                    return `${m}:${s < 10 ? '0' : ''}${s}`;
                }

                // 核心渲染逻辑
                function updateUI() {
                    const current = audio.currentTime;
                    const duration = audio.duration || 0;
                    timeDisplay.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
                    
                    // 只有当用户没有在拖动进度条时，才自动更新进度条位置
                    if (document.activeElement !== range) {
                        range.value = (current / duration) * 100 || 0;
                        updateRangeBackground(range);
                    }

                    if (lyricsDiv && audio.lrcData) {
                        let currentLineText = "";
                        
                        for (let i = 0; i < audio.lrcData.length; i++) {
                            if (audio.lrcData[i].time <= current) {
                                currentLineText = audio.lrcData[i].text;
                            } else {
                                break;
                            }
                        }

                        if (currentLineText && currentLineText.trim() !== "") {
                            lyricsDiv.textContent = currentLineText;
                            lyricsDiv.classList.add('active');
                        } else {
                            if (!audio.paused) {
                                if (!lyricsDiv.querySelector('.placeholder-icon')) {
                                    lyricsDiv.innerHTML = '<span class="material-symbols-rounded placeholder-icon">music_note</span>';
                                }
                                lyricsDiv.classList.add('active');
                            } else {
                                lyricsDiv.classList.remove('active');
                            }
                        }
                    }
                }

                // --- 新增：循环渲染函数 ---
                function renderLoop() {
                    updateUI();
                    // 如果音乐正在播放，请求下一帧
                    if (!audio.paused) {
                        animationFrameId = requestAnimationFrame(renderLoop);
                    }
                }
                
                function updateRangeBackground(input) {
                    const value = input.value;
                    input.style.background = `linear-gradient(to right, #76FF33 0%, #76FF33 ${value}%, rgba(191, 213, 255, 0.2) ${value}%, rgba(191, 213, 255, 0.2) 100%)`;
                }

                btn.addEventListener('click', () => {
                    if (audio.paused) {
                        // 暂停其他所有播放器
                        allAudios.forEach(a => {
                            if (a !== audio) {
                                a.pause();
                                const otherIcon = a.parentElement.querySelector('.play-btn span');
                                if(otherIcon) otherIcon.textContent = 'play_arrow';
                                // 注意：其他播放器的 pause 事件会自动触发它们的 cancelAnimationFrame
                            }
                        });
                        
                        audio.play();
                        icon.textContent = 'pause';
                        
                        // 开始高频渲染循环
                        cancelAnimationFrame(animationFrameId); // 防止重复开启
                        renderLoop();
                    } else {
                        audio.pause();
                        icon.textContent = 'play_arrow';
                        
                        // 停止循环 (pause事件也会触发停止，双重保险)
                        cancelAnimationFrame(animationFrameId);
                        updateUI(); // 最后更新一次确保状态正确
                    }
                });

                range.addEventListener('input', () => {
                    if (audio.duration) {
                        audio.currentTime = (range.value / 100) * audio.duration;
                        updateRangeBackground(range);
                        updateUI(); // 拖动时立即更新文字和歌词
                    }
                });

                // 初始化 UI
                audio.addEventListener('loadedmetadata', updateUI);
                
                // 监听 pause 事件以确保外部原因暂停时也能停止循环
                audio.addEventListener('pause', () => {
                    cancelAnimationFrame(animationFrameId);
                    updateUI();
                });

                audio.addEventListener('ended', () => {
                   cancelAnimationFrame(animationFrameId); // 停止循环
                   if(!audio.loop) {
                       icon.textContent = 'play_arrow';
                       range.value = 0;
                       updateRangeBackground(range);
                       if(lyricsDiv) {
                           lyricsDiv.classList.remove('active');
                       }
                   }
                });

                updateRangeBackground(range);
            });
        });
    </script>
</body>
</html>
