<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D坦克物品名称中英互译</title>
    
    <!-- 字体加载 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;500;700;800&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- M3 Design Tokens --- */
        :root {
            /* 基础色板 */
            --md-sys-color-background: #001926;
            --md-sys-color-on-background: #BFD5FF;
            --md-sys-color-primary: #76FF33;
            --md-sys-color-on-primary: #001926;
            
            /* 表面色 */
            --md-sys-color-surface-container: #002538; 
            --md-sys-color-surface-container-high: #00314a; 
            
            --md-sys-color-outline: #4a6a8a;
            --md-sys-color-outline-variant: #2c465e;

            /* 形状 */
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-full: 100px;

            /* 字体栈：严格 Rubik 优先，M PLUS 1p 其次 */
            --md-sys-typescale-global: 'Rubik', 'M PLUS 1p', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: var(--md-sys-typescale-global);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* 强制所有元素继承字体，确保 Rubik 优先 */
        h1, h2, h3, h4, h5, h6, p, span, div,
        button, input, textarea, select, 
        .mode-option, .glossary-item, .info-text, label {
            font-family: var(--md-sys-typescale-global) !important;
        }

        /* --- Header --- */
        header {
            padding: 32px 20px 16px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-weight: 700;
            font-size: 28px;
            color: var(--md-sys-color-primary);
            line-height: 1.3;
        }

        /* --- Main Layout --- */
        main {
            flex-grow: 1;
            padding: 20px;
            max-width: 840px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Cards --- */
        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .info-text {
            font-size: 14px;
            color: var(--md-sys-color-on-background);
            opacity: 0.8;
            margin: 0 0 20px 0;
            text-align: center;
        }

        /* --- Mode Switcher --- */
        .mode-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background-color: var(--md-sys-color-background);
            border-radius: var(--md-sys-shape-corner-full);
            padding: 4px;
            margin-bottom: 24px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }
        
        .mode-option {
            text-align: center;
            padding: 10px;
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            color: var(--md-sys-color-on-background);
        }
        
        .mode-option.active {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            font-weight: 700;
        }

        /* --- Input Fields --- */
        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 12px;
        }

        textarea, input[type="text"] {
            width: 100%;
            background-color: var(--md-sys-color-surface-container-high);
            border: 2px solid transparent;
            border-radius: var(--md-sys-shape-corner-large);
            color: #fff;
            padding: 16px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.2s ease;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            background-color: #003855;
            border-color: var(--md-sys-color-primary);
        }

        #inputText { height: 140px; border-radius: 16px 16px 4px 4px; }
        
        #outputBox {
            min-height: 140px;
            background-color: var(--md-sys-color-background);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 16px;
            padding: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: text;
        }

        /* --- Switch --- */
        .switch-container {
            display: flex;
            align-items: center;
            margin: 16px 0 24px 0;
            cursor: pointer;
            user-select: none;
            padding: 4px 0;
        }
        .switch-input { opacity: 0; position: absolute; }
        .switch-track {
            width: 52px; height: 32px;
            background-color: var(--md-sys-color-surface-container-high);
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 100px; position: relative;
            transition: 0.3s;
        }
        .switch-thumb {
            width: 16px; height: 16px;
            background-color: var(--md-sys-color-outline);
            border-radius: 50%;
            position: absolute; top: 50%; left: 6px;
            transform: translateY(-50%);
            transition: 0.3s;
        }
        .switch-input:checked + .switch-track {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }
        .switch-input:checked + .switch-track .switch-thumb {
            background-color: var(--md-sys-color-on-primary);
            left: calc(100% - 22px);
            width: 24px; height: 24px;
        }
        .switch-label-text { margin-left: 16px; font-size: 15px; font-weight: 500; }

        /* --- Buttons --- */
        .button-row { display: flex; gap: 12px; flex-wrap: wrap; }
        button {
            border: none; 
            font-size: 14px; font-weight: 700;
            height: 48px;
            padding: 0 28px; 
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--md-sys-color-on-primary);
            background-color: var(--md-sys-color-primary);
            flex-grow: 1;
        }
        button:active { transform: scale(0.96); }
        button#btnSave {
            background-color: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            flex-grow: 0;
        }

        /* --- Glossary --- */
        .glossary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 16px;
        }
        
        .search-box { flex-grow: 1; }
        .search-box input {
            height: 48px;
            border-radius: var(--md-sys-shape-corner-full);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a6a8a'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 16px center;
            background-size: 20px;
            padding-left: 48px;
            border: none;
            background-color: var(--md-sys-color-surface-container-high);
        }
        .search-box input:focus {
            background-color: #003855;
            box-shadow: 0 0 0 2px var(--md-sys-color-primary);
        }

        .glossary-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--md-sys-shape-corner-large);
            background-color: rgba(0, 0, 0, 0.2);
            padding: 8px;
        }

        .glossary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(74, 106, 138, 0.2);
            font-size: 14px;
        }
        .glossary-item:last-child { border-bottom: none; }
        .g-key { color: var(--md-sys-color-on-background); font-weight: 500; }
        .g-val { color: var(--md-sys-color-primary); text-align: right; font-weight: 700; }

        /* --- Toast --- */
        #toast {
            visibility: hidden; min-width: 200px;
            background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
            text-align: center; border-radius: 50px; padding: 12px 24px;
            position: fixed; z-index: 100; left: 50%; bottom: 30px;
            transform: translateX(-50%) scale(0.9);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; transform: translateX(-50%) scale(1); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline); border-radius: 10px; }

    </style>
</head>
<body>

    <header>
        <h1 id="appTitle">3D坦克物品名称中英互译</h1>
    </header>

    <main>
        <!-- Translation Card -->
        <section class="card">
            <p class="info-text" id="appDesc">不支持翻译整句话</p>
            
            <!-- Mode Switcher -->
            <div class="mode-switcher">
                <div class="mode-option active" id="modeEnToCn" onclick="setMode('en2cn')">英文 → 中文</div>
                <div class="mode-option" id="modeCnToEn" onclick="setMode('cn2en')">中文 → 英文</div>
            </div>

            <div class="input-wrapper">
                <label for="inputText" id="labelInput">输入名称</label>
                <textarea id="inputText" oninput="replaceAndDisplay()"></textarea>
            </div>

            <!-- Case Toggle -->
            <label class="switch-container" id="caseToggleContainer">
                <input type="checkbox" id="caseSensitiveToggle" class="switch-input" checked onchange="replaceAndDisplay()">
                <div class="switch-track">
                    <div class="switch-thumb"></div>
                </div>
                <span class="switch-label-text" id="labelCase">启用大小写规则</span>
            </label>

            <div class="button-row">
                <button onclick="copyResult()" id="btnCopy">复制结果</button>
                <button onclick="saveToFile()" id="btnSave">保存为文件</button>
            </div>

            <div class="input-wrapper" style="margin-top: 24px;">
                <label for="outputBox" id="labelOutput">翻译结果</label>
                <div id="outputBox" role="textbox" aria-readonly="true"></div>
            </div>
            
            <div class="input-wrapper" style="margin-top: 12px; margin-bottom: 0;">
                <label for="fileName" id="labelFilename">文件名 (可选)</label>
                <input type="text" id="fileName" placeholder="translation_result" />
            </div>
        </section>

        <!-- Glossary Card -->
        <section class="card">
            <div class="glossary-header">
                <h2 id="labelGlossaryTitle" style="margin:0; font-size:18px; color:var(--md-sys-color-primary);">词汇表</h2>
                <div class="search-box">
                    <input type="text" id="glossarySearch" placeholder="搜索 / Search..." oninput="filterGlossary()">
                </div>
            </div>
            <div id="glossaryContainer" class="glossary-list">
                <div style="padding:16px; text-align:center; color: #888;">Loading dictionary...</div>
            </div>
        </section>
    </main>

    <div id="toast">已复制 / Copied!</div>

    <!-- Scripts -->
    <script src="https://testanki1.github.io/translations.js"></script>
    <script src="https://unpkg.com/pluralize@latest/pluralize.js"></script>

    <script>
        // --- Global State ---
        let currentMode = 'en2cn'; 
        let translationDict = {}; // Dict with plurals (EN->CN)
        let displayDict = {};     // Raw dict (Glossary)
        let reverseDict = {};     // Dict (CN->EN)

        // --- Localization ---
        const i18n = {
            'zh': {
                title: '3D坦克物品名称中英互译', 
                desc: '不支持翻译整句话',
                modeEn: '英文 → 中文',
                modeCn: '中文 → 英文',
                inputLabel: '输入物品名称',
                inputPlaceholder: '在此处粘贴...',
                caseLabel: '启用大小写规则 (区分大小写)',
                btnCopy: '复制结果',
                btnSave: '保存为文件',
                filenameLabel: '文件名 (可选)',
                outputLabel: '翻译结果',
                glossaryTitle: '词汇表',
                searchPlaceholder: '搜索...',
                toast: '文本已成功复制到剪贴板！'
            },
            'en': {
                title: 'Tanki Online Item Name Translation',
                desc: 'Do not support full sentence translation.',
                modeEn: 'English → Chinese',
                modeCn: 'Chinese → English',
                inputLabel: 'Input Item Names',
                inputPlaceholder: 'Paste text here...',
                caseLabel: 'Enable Case Sensitivity',
                btnCopy: 'Copy Result',
                btnSave: 'Save to File',
                filenameLabel: 'Filename (Optional)',
                outputLabel: 'Translation Result',
                glossaryTitle: 'Glossary',
                searchPlaceholder: 'Search...',
                toast: 'Text copied to clipboard!'
            }
        };

        const lang = navigator.language.startsWith('zh') ? 'zh' : 'en';
        const t = i18n[lang];

        function applyLanguage() {
            document.title = t.title;
            document.getElementById('appTitle').innerText = t.title;
            
            document.documentElement.lang = lang;
            document.getElementById('appDesc').innerText = t.desc;
            document.getElementById('modeEnToCn').innerText = t.modeEn;
            document.getElementById('modeCnToEn').innerText = t.modeCn;
            document.getElementById('labelInput').innerText = t.inputLabel;
            document.getElementById('inputText').placeholder = t.inputPlaceholder;
            document.getElementById('labelCase').innerText = t.caseLabel;
            document.getElementById('btnCopy').innerText = t.btnCopy;
            document.getElementById('btnSave').innerText = t.btnSave;
            document.getElementById('labelFilename').innerText = t.filenameLabel;
            document.getElementById('labelOutput').innerText = t.outputLabel;
            document.getElementById('labelGlossaryTitle').innerText = t.glossaryTitle;
            document.getElementById('glossarySearch').placeholder = t.searchPlaceholder;
            document.getElementById('toast').innerText = t.toast;
        }

        // --- Mode Switching ---
        function setMode(mode) {
            currentMode = mode;
            const btnEn = document.getElementById('modeEnToCn');
            const btnCn = document.getElementById('modeCnToEn');
            const caseToggle = document.getElementById('caseToggleContainer');
            
            if (mode === 'en2cn') {
                btnEn.classList.add('active');
                btnCn.classList.remove('active');
                caseToggle.style.display = 'flex';
            } else {
                btnCn.classList.add('active');
                btnEn.classList.remove('active');
                caseToggle.style.display = 'none';
            }
            replaceAndDisplay();
        }

        // --- Dictionary Init ---
        function initDictionary() {
            if (typeof replacementDict === 'undefined' || !replacementDict) {
                console.error("Dictionary not found");
                return;
            }

            // 1. Display Dict (Raw)
            displayDict = { ...replacementDict };

            // 2. Translation Dict (with Plurals for EN->CN)
            translationDict = { ...replacementDict };
            if (typeof pluralize !== 'undefined') {
                const additions = {};
                for (const key in translationDict) {
                    if (translationDict.hasOwnProperty(key) && key.length > 0) {
                        try {
                            const pluralKey = pluralize(key);
                            if (pluralKey !== key && !translationDict.hasOwnProperty(pluralKey)) {
                                additions[pluralKey] = translationDict[key];
                            }
                        } catch (e) {}
                    }
                }
                Object.assign(translationDict, additions);
            }

            // 3. Reverse Dict (CN->EN, Single words only)
            for (const enKey in displayDict) {
                const cnVal = displayDict[enKey];
                if (!reverseDict[cnVal]) {
                    reverseDict[cnVal] = [];
                }
                if (!reverseDict[cnVal].includes(enKey)) {
                    reverseDict[cnVal].push(enKey);
                }
            }

            renderGlossary();
        }

        // --- Glossary (No Plurals) ---
        function renderGlossary(filterText = '') {
            const container = document.getElementById('glossaryContainer');
            const keys = Object.keys(displayDict).sort((a, b) => a.localeCompare(b));
            const lowerFilter = filterText.toLowerCase();
            
            let html = '';
            let count = 0;

            for (const key of keys) {
                const val = displayDict[key];
                if (key.toLowerCase().includes(lowerFilter) || val.toLowerCase().includes(lowerFilter)) {
                    html += `
                        <div class="glossary-item">
                            <span class="g-key">${escapeHtml(key)}</span>
                            <span class="g-val">${escapeHtml(val)}</span>
                        </div>
                    `;
                    count++;
                }
            }

            if (count === 0) {
                container.innerHTML = '<div style="padding:16px; text-align:center; opacity:0.6">No matches found</div>';
            } else {
                container.innerHTML = html;
            }
        }

        function filterGlossary() {
            renderGlossary(document.getElementById('glossarySearch').value);
        }

        // --- Core Logic ---
        const outputElement = document.getElementById('outputBox');
        const inputTextElement = document.getElementById('inputText');

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        function isWordChar(char) {
             return typeof char === 'string' && char.length > 0 && /[a-zA-Z0-9_]/.test(char);
        }
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function performTranslation() {
            const originalInput = inputTextElement.value;
            if (!originalInput) {
                outputElement.textContent = '';
                return;
            }
            if (Object.keys(translationDict).length === 0) {
                outputElement.textContent = "Loading...";
                return;
            }

            const allMatches = [];

            if (currentMode === 'en2cn') {
                // EN -> CN
                const isCaseSensitive = document.getElementById('caseSensitiveToggle').checked;
                const keys = Object.keys(translationDict);

                for (const key of keys) {
                    if (!key) continue;
                    let prefix = (key.length > 0 && isWordChar(key[0])) ? '\\b' : '';
                    let suffix = (key.length > 0 && isWordChar(key[key.length - 1])) ? '\\b' : '';
                    const regexString = `${prefix}${escapeRegExp(key)}${suffix}`;
                    
                    try {
                        const regex = new RegExp(regexString, 'gi'); 
                        let match;
                        while ((match = regex.exec(originalInput)) !== null) {
                            let valid = true;
                            if (isCaseSensitive) {
                                for (let i = 0; i < key.length; i++) {
                                    if (key[i] >= 'A' && key[i] <= 'Z') {
                                        if (match[0][i] < 'A' || match[0][i] > 'Z') {
                                            valid = false;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (valid) {
                                allMatches.push({
                                    start: match.index,
                                    end: match.index + match[0].length,
                                    value: translationDict[key],
                                    length: match[0].length
                                });
                            }
                        }
                    } catch(e) {}
                }

            } else {
                // CN -> EN
                const keys = Object.keys(reverseDict);
                for (const key of keys) {
                    if (!key) continue;
                    try {
                        const regex = new RegExp(escapeRegExp(key), 'g');
                        let match;
                        while ((match = regex.exec(originalInput)) !== null) {
                            const enValues = reverseDict[key];
                            // Format: Single or (A | B)
                            let finalVal = enValues[0];
                            if (enValues.length > 1) {
                                finalVal = `(${enValues.join(' | ')})`;
                            }
                            allMatches.push({
                                start: match.index,
                                end: match.index + match[0].length,
                                value: finalVal,
                                length: match[0].length
                            });
                        }
                    } catch(e) {}
                }
            }

            // Sort & Replace
            allMatches.sort((a, b) => {
                if (a.start !== b.start) return a.start - b.start;
                return b.length - a.length;
            });

            let output = '';
            let cursor = 0;

            // --- Helper to check for space insertion ---
            // Is English-like (letters, numbers, parens, pipe)
            const isEn = (char) => /[a-zA-Z0-9()|]/.test(char);
            // Is Chinese-like
            const isCn = (char) => /[\u4E00-\u9FFF]/.test(char);
            
            // Returns true if we need a space between c1 and c2
            const needsSpace = (c1, c2) => {
                if (!c1 || !c2) return false;
                // English + English
                if (isEn(c1) && isEn(c2)) return true;
                // English + Chinese
                if (isEn(c1) && isCn(c2)) return true;
                // Chinese + English
                if (isCn(c1) && isEn(c2)) return true;
                return false;
            };
            // -------------------------------------------

            for (const match of allMatches) {
                if (match.start >= cursor) {
                    // 1. Get the prefix (untranslated text before this match)
                    let prefix = originalInput.substring(cursor, match.start);

                    // 2. Handle connection between Previous Output and Prefix
                    // Only for CN -> EN mode
                    if (currentMode === 'cn2en' && output.length > 0 && prefix.length > 0) {
                        if (needsSpace(output[output.length-1], prefix[0])) {
                            output += ' ';
                        }
                    }
                    output += prefix;

                    // 3. Handle connection between Prefix (or Previous Output) and Match
                    if (currentMode === 'cn2en' && output.length > 0) {
                         if (needsSpace(output[output.length-1], match.value[0])) {
                            output += ' ';
                         }
                    }
                    output += match.value;
                    
                    cursor = match.end;
                }
            }
            
            // Append remaining text (Suffix)
            if (cursor < originalInput.length) {
                let suffix = originalInput.substring(cursor);
                
                if (currentMode === 'cn2en' && output.length > 0 && suffix.length > 0) {
                    if (needsSpace(output[output.length-1], suffix[0])) {
                        output += ' ';
                    }
                }
                output += suffix;
            }

            // Remove spaces between Chinese chars (EN->CN only)
            if (currentMode === 'en2cn') {
                output = output.replace(/([\u4E00-\u9FFF])( +)([\u4E00-\u9FFF])/g, '$1$3');
            }

            outputElement.textContent = output;
        }

        const replaceAndDisplay = debounce(performTranslation, 200);

        // --- Utils ---
        function showToast() {
            const toast = document.getElementById('toast');
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
        }

        function copyResult() {
            const text = outputElement.textContent;
            if (!text) return;
            navigator.clipboard.writeText(text).then(showToast).catch(() => alert('Copy failed'));
        }

        function saveToFile() {
            const text = outputElement.textContent;
            if (!text) return;
            let name = document.getElementById('fileName').value.trim();
            if (!name) {
                const now = new Date();
                name = `tanki_translation_${now.getTime()}`;
            }
            if (!name.endsWith('.txt')) name += '.txt';
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        applyLanguage();
        window.addEventListener('load', () => {
            setTimeout(initDictionary, 100);
        });

    </script>
</body>
</html>
