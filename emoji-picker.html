<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Picker</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        /* --- 1. Design Tokens --- */
        :root {
            --sys-primary: #6750A4;
            --sys-on-primary: #FFFFFF;
            --sys-primary-container: #EADDFF;
            --sys-on-primary-container: #21005D;
            
            --sys-secondary: #625B71;
            --sys-secondary-container: #E8DEF8;
            --sys-on-secondary-container: #1D192B;

            --sys-surface: #FFFBFE;
            --sys-surface-container-low: #F7F2FA;
            --sys-surface-container: #F3EDF7;
            --sys-surface-container-high: #ECE6F0;
            --sys-on-surface: #1C1B1F;
            --sys-on-surface-variant: #49454F;
            --sys-outline: #79747E;
            --sys-outline-variant: #CAC4D0;

            --sys-inverse-surface: #313033;
            --sys-inverse-on-surface: #F4EFF4;

            /* Typography */
            --type-display: 400 32px/40px system-ui, -apple-system, sans-serif;
            --type-headline: 400 24px/32px system-ui, -apple-system, sans-serif;
            --type-label: 500 12px/16px system-ui, -apple-system, sans-serif;
            --type-body: 400 16px/24px system-ui, -apple-system, sans-serif;

            /* Shape & Spacing */
            --shape-full: 999px;
            --shape-xl: 28px;
            --shape-lg: 16px;
            --shape-md: 12px;
            
            /* Layout */
            --nav-width-desktop: 88px;
            --nav-height-mobile: 80px;
        }

        /* --- 2. Global Reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--sys-surface);
            color: var(--sys-on-surface);
            font-family: system-ui, -apple-system, Roboto, sans-serif;
            height: 100dvh;
            display: flex;
            overflow: hidden;
        }

        /* --- 3. Layout Structure --- */
        @media (min-width: 800px) {
            body { flex-direction: row; }
            nav {
                width: var(--nav-width-desktop);
                height: 100%;
                flex-direction: column;
                border-right: 1px solid var(--sys-outline-variant);
                border-top: none;
                padding: 24px 0;
            }
            main { padding: 0 48px 48px; }
            .app-container { max-width: 1200px; margin: 0 auto; width: 100%; }
        }

        @media (max-width: 799px) {
            body { flex-direction: column; }
            nav {
                width: 100%;
                height: var(--nav-height-mobile);
                flex-direction: row;
                bottom: 0; left: 0; position: fixed;
                border-top: 1px solid var(--sys-surface-container-high);
                background: var(--sys-surface-container);
            }
            main { padding: 0 16px 120px; }
        }

        /* --- 4. Navigation --- */
        nav {
            background: var(--sys-surface-container);
            display: flex; align-items: center; justify-content: center;
            gap: 8px; z-index: 50; flex-shrink: 0;
        }

        .nav-scroll-container {
            display: flex; gap: 4px; overflow: auto; scrollbar-width: none;
        }
        .nav-scroll-container::-webkit-scrollbar { display: none; }

        @media (min-width: 800px) { .nav-scroll-container { flex-direction: column; width: 100%; align-items: center; } }
        @media (max-width: 799px) { .nav-scroll-container { flex-direction: row; width: 100%; padding: 0 16px; align-items: center; } }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; min-width: 64px; min-height: 64px;
            color: var(--sys-on-surface-variant); transition: 0.2s; border-radius: 16px;
            position: relative;
        }
        
        .nav-icon-box {
            width: 56px; height: 32px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s cubic-bezier(0.2, 0, 0, 1);
            margin-bottom: 4px;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
        .nav-item.active .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .nav-item.active { color: var(--sys-on-surface); }
        .nav-item.active .nav-icon-box {
            background-color: var(--sys-secondary-container);
            color: var(--sys-on-secondary-container);
        }
        .nav-label { font: var(--type-label); text-align: center; opacity: 0.8; font-size: 11px; }

        /* --- 5. Main Content --- */
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; background: var(--sys-surface); }

        .top-bar {
            padding: 16px 0 16px; position: sticky; top: 0;
            background: rgba(255, 251, 254, 0.95); backdrop-filter: blur(10px);
            z-index: 40;
        }
        @media (prefers-color-scheme: dark) { .top-bar { background: rgba(20, 18, 24, 0.95); } }

        h1 { font: var(--type-display); margin: 0 0 16px 16px; color: var(--sys-on-surface); }

        /* Search Bar */
        .search-container {
            margin: 0 16px 12px;
            background: var(--sys-surface-container-high);
            border-radius: 28px;
            display: flex; align-items: center;
            height: 56px; padding: 0 16px;
            transition: 0.2s;
        }
        .search-container:focus-within {
            background: var(--sys-surface-container);
            box-shadow: 0 0 0 2px var(--sys-primary);
        }
        .search-icon { color: var(--sys-on-surface-variant); font-size: 24px; }
        .search-input {
            border: none; background: transparent;
            flex: 1; height: 100%;
            font-size: 16px; color: var(--sys-on-surface);
            outline: none; margin-left: 12px;
            font-family: inherit;
        }
        .search-input::placeholder { color: var(--sys-outline); }
        .clear-icon {
            color: var(--sys-on-surface-variant); cursor: pointer;
            font-size: 20px; display: none;
        }
        .search-input:not(:placeholder-shown) + .clear-icon { display: block; }

        /* Filters */
        .chips-row { display: flex; gap: 8px; overflow-x: auto; padding: 0 16px 4px; scrollbar-width: none; }
        .chips-row::-webkit-scrollbar { display: none; }

        .chip {
            height: 32px; padding: 0 16px; border-radius: 8px;
            border: 1px solid var(--sys-outline); background: transparent;
            color: var(--sys-on-surface-variant); font: var(--type-label); font-weight: 500;
            cursor: pointer; white-space: nowrap; transition: 0.2s; user-select: none;
        }
        .chip:hover { background: var(--sys-surface-container-high); }
        .chip.selected {
            background: var(--sys-secondary-container);
            color: var(--sys-on-secondary-container); border-color: transparent;
        }

        .group-section { margin-top: 32px; scroll-margin-top: 140px; }
        .group-title { font: var(--type-headline); color: var(--sys-on-surface); margin-bottom: 16px; padding-left: 4px; }
        
        .subgroup-pill {
            display: inline-block; font: var(--type-label); color: var(--sys-primary);
            background: var(--sys-surface-container-high); padding: 6px 12px;
            border-radius: 8px; margin: 16px 0 8px; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 8px; margin-bottom: 16px; }

        .variant-card {
            grid-column: 1 / -1; background: var(--sys-surface-container-high);
            border-radius: var(--shape-lg); padding: 12px;
            display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px;
        }

        .emoji-btn {
            width: 48px; height: 48px; font-size: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: var(--shape-full); cursor: pointer;
            transition: background 0.2s, transform 0.1s; user-select: none; position: relative;
        }
        .emoji-btn:hover { background: var(--sys-surface-container-high); }
        .variant-card .emoji-btn:hover { background: var(--sys-surface-container); }
        .emoji-btn:active { transform: scale(0.9); background: var(--sys-outline-variant); }

        .emoji-btn.separator { margin-right: 12px; }
        .emoji-btn.separator::after {
            content: ""; position: absolute; right: -10px; top: 10px; bottom: 10px;
            width: 1px; border-right: 2px dashed var(--sys-outline-variant);
        }

        /* --- 6. Overlays --- */
        #tooltip {
            position: fixed; z-index: 2000; background: var(--sys-inverse-surface);
            color: var(--sys-inverse-on-surface); padding: 8px 16px;
            border-radius: var(--shape-md); font-size: 14px; text-align: center;
            pointer-events: none; opacity: 0; white-space: nowrap; width: max-content; max-width: 90vw;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: opacity 0.15s ease-out;
        }
        #tooltip.visible { opacity: 1; }
        .tt-main { display: block; font-weight: 600; }
        .tt-sub { display: block; font-size: 12px; opacity: 0.8; margin-top: 2px; font-weight: 400; }

        #snackbar {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--sys-inverse-surface); color: var(--sys-inverse-on-surface);
            padding: 14px 24px; border-radius: var(--shape-full); font: var(--type-body); font-size: 14px;
            display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.05, 0.7, 0.1, 1.0); z-index: 3000;
        }
        #snackbar.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        @media (max-width: 799px) { #snackbar { bottom: 100px; } }

        #loading {
            position: fixed; inset: 0; z-index: 5000; background: var(--sys-surface);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 24px; transition: opacity 0.4s;
        }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--sys-surface-container-high);
            border-top-color: var(--sys-primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading">
        <div class="loader"></div>
        <div style="font: var(--type-headline); color: var(--sys-primary);" id="loading-title">Emoji Picker</div>
        <div style="font: var(--type-label); color: var(--sys-outline);" id="loading-text">Loading...</div>
    </div>

    <nav>
        <div class="nav-scroll-container" id="nav-container"></div>
    </nav>

    <main id="main-scroll">
        <div class="app-container">
            <div class="top-bar">
                <h1>Emoji Picker</h1>
                <div class="search-container">
                    <span class="material-symbols-rounded search-icon">search</span>
                    <input type="text" class="search-input" id="search-input" placeholder="Search...">
                    <span class="material-symbols-rounded clear-icon" id="clear-search">close</span>
                </div>
                <div class="chips-row" id="filter-container"></div>
            </div>
            <div id="content-area"></div>
        </div>
    </main>

    <div id="tooltip"></div>
    <div id="snackbar"></div>

    <script>
        (function() {
            'use strict';

            // --- 1. 国际化配置 (I18N) ---
            const IS_ZH = navigator.language.startsWith('zh');

            const PROXY = 'https://api.codetabs.com/v1/proxy?quest=';
            const URL_STRUCTURE = 'https://www.unicode.org/Public/emoji/latest/emoji-test.txt';
            // 根据语言选择 CLDR 数据源
            const URL_TRANSLATION = IS_ZH 
                ? 'https://raw.githubusercontent.com/unicode-org/cldr/refs/heads/main/common/annotations/zh.xml'
                : 'https://raw.githubusercontent.com/unicode-org/cldr/refs/heads/main/common/annotations/en.xml';

            const UI_STRINGS = {
                loadingTitle: IS_ZH ? "Emoji 库" : "Emoji Picker",
                loadingText: IS_ZH ? "正在加载 Unicode 结构与翻译..." : "Loading Unicode structure and translations...",
                searchPlaceholder: IS_ZH ? "搜索表情 (如: 好的, ok, 挥手)" : "Search emojis (e.g. happy, cat)",
                noResult: IS_ZH ? "未找到匹配的表情" : "No matching emojis found",
                copied: IS_ZH ? "已复制" : "Copied"
            };

            // 10大分类映射
            const GROUP_MAP_ZH = {
                "Smileys & Emotion": "表情与情感",
                "People & Body": "人物与身体",
                "Component": "组件",
                "Animals & Nature": "动物与自然",
                "Food & Drink": "食物与饮料",
                "Travel & Places": "旅行与地点",
                "Activities": "活动",
                "Objects": "物品",
                "Symbols": "符号",
                "Flags": "旗帜"
            };

            // 状态映射
            const STATUS_MAP_ZH = {
                "fully-qualified": "全限定",
                "minimally-qualified": "最小限定",
                "unqualified": "无限定",
                "component": "组件"
            };
            const STATUS_MAP_EN = {
                "fully-qualified": "Fully Qualified",
                "minimally-qualified": "Minimally Qualified",
                "unqualified": "Unqualified",
                "component": "Component"
            };

            // 手动补全字典 (仅中文需要，英文直接用原文)
            const MANUAL_TERMS_ZH = {
                "man": "男人", "woman": "女人", "person": "人",
                "boy": "男孩", "girl": "女孩", "child": "儿童", "baby": "婴儿",
                "older person": "老人", "adult": "成人",
                "holding hands": "牵手", "family": "家庭", "kiss": "亲吻",
                "couple with heart": "恋爱",
                "blond hair": "金发", "beard": "胡须", "red hair": "红发",
                "curly hair": "卷发", "white hair": "白发", "bald": "秃头",
                "mx claus": "圣诞老人(中性)", "mrs. claus": "圣诞奶奶", "santa claus": "圣诞老人",
                "people wrestling": "摔跤", "men wrestling": "男人摔跤", "women wrestling": "女人摔跤"
            };

            const ICON_MAP = {
                "Smileys & Emotion": "emoji_emotions",
                "People & Body": "emoji_people",
                "Component": "palette",
                "Animals & Nature": "emoji_nature",
                "Food & Drink": "emoji_food_beverage",
                "Travel & Places": "emoji_transportation",
                "Activities": "emoji_events",
                "Objects": "emoji_objects",
                "Symbols": "emoji_symbols",
                "Flags": "emoji_flags"
            };

            let rawData = {};
            let translationMap = {}; 
            let keywordMap = {};     
            let componentMap = {}; 
            let activeStatus = '';
            let isScrolling = false;
            let tooltipTimeout;
            let longPressTimer;

            const ui = {
                loading: document.getElementById('loading'),
                loadingTitle: document.getElementById('loading-title'),
                loadingText: document.getElementById('loading-text'),
                nav: document.getElementById('nav-container'),
                filters: document.getElementById('filter-container'),
                content: document.getElementById('content-area'),
                main: document.getElementById('main-scroll'),
                tooltip: document.getElementById('tooltip'),
                snackbar: document.getElementById('snackbar'),
                searchInput: document.getElementById('search-input'),
                clearSearch: document.getElementById('clear-search')
            };

            async function init() {
                // 应用 UI 文本
                ui.loadingTitle.textContent = UI_STRINGS.loadingTitle;
                ui.loadingText.textContent = UI_STRINGS.loadingText;
                ui.searchInput.placeholder = UI_STRINGS.searchPlaceholder;
                document.querySelector('h1').textContent = UI_STRINGS.loadingTitle;

                try {
                    const [structRes, transRes] = await Promise.all([
                        fetch(PROXY + encodeURIComponent(URL_STRUCTURE)),
                        fetch(PROXY + encodeURIComponent(URL_TRANSLATION))
                    ]);

                    if (!structRes.ok || !transRes.ok) throw new Error('Network Error');

                    const structText = await structRes.text();
                    const transText = await transRes.text();

                    parseTranslations(transText);
                    processStructure(structText);
                    buildUI();
                    
                    ui.searchInput.addEventListener('input', () => renderMainContent());
                    ui.clearSearch.addEventListener('click', () => {
                        ui.searchInput.value = '';
                        renderMainContent();
                        ui.searchInput.focus();
                    });

                    ui.loading.style.opacity = '0';
                    setTimeout(() => ui.loading.style.display = 'none', 400);
                } catch (err) {
                    console.error(err);
                    ui.loading.innerHTML = `<div style="text-align:center; color:#B3261E"><h3>Error</h3><p>${err.message}</p></div>`;
                }
            }

            function parseTranslations(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                const annotations = xmlDoc.querySelectorAll("annotation");
                annotations.forEach(node => {
                    const char = node.getAttribute("cp");
                    const type = node.getAttribute("type");
                    if (type === 'tts' && char) {
                        translationMap[char] = node.textContent;
                    } else if (!type && char) {
                        keywordMap[char] = node.textContent;
                    }
                });
            }

            function processStructure(text) {
                const lines = text.split('\n');
                
                // 如果是中文，加载手动字典；英文则不需要
                if (IS_ZH) {
                    Object.assign(componentMap, MANUAL_TERMS_ZH);
                }

                // 1. 构建组件字典
                lines.forEach(line => {
                    line = line.trim();
                    if (!line || line.startsWith('#') || !line.includes('; component')) return;
                    const [codes, meta] = line.split(';');
                    const [status, comment] = meta.split('#');
                    const commentParts = comment.trim().split(' '); 
                    const char = commentParts[0];
                    const nameEn = commentParts.slice(2).join(' ');
                    
                    // 如果是中文，尝试查找翻译；英文直接用原文
                    if (IS_ZH) {
                        const nameZh = translationMap[char];
                        if (nameZh) componentMap[nameEn.toLowerCase()] = nameZh;
                    } else {
                        componentMap[nameEn.toLowerCase()] = nameEn; // 英文映射到自身
                    }
                });

                // 2. 处理 Emoji
                let group = "Unknown", subgroup = "Unknown";
                let baseTranslationCache = {}; 

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    if (line.startsWith('# group:')) {
                        group = line.split(': ')[1].trim();
                    } else if (line.startsWith('# subgroup:')) {
                        subgroup = line.split(': ')[1].trim();
                    } else if (!line.startsWith('#') && line.includes(';')) {
                        const [codes, meta] = line.split(';');
                        const [status, comment] = meta.split('#');
                        const cleanStatus = status.trim();
                        
                        const commentParts = comment.trim().split(' '); 
                        const char = commentParts[0];
                        const nameFullEn = commentParts.slice(2).join(' ');
                        const [baseEn, ...qualParts] = nameFullEn.split(':');
                        const qualEn = qualParts.join(':').trim();
                        const baseEnTrimmed = baseEn.trim();

                        let baseDisplayName = null;
                        
                        // 尝试获取翻译
                        baseDisplayName = translationMap[char];
                        if (!baseDisplayName) baseDisplayName = translationMap[char.replace(/\uFE0F/g, '')];
                        if (!baseDisplayName) {
                            const noSkin = char.replace(/[\u{1F3FB}-\u{1F3FF}]/gu, '');
                            baseDisplayName = translationMap[noSkin];
                            if (!baseDisplayName) baseDisplayName = translationMap[noSkin.replace(/\uFE0F/g, '')];
                        }

                        // 回退逻辑
                        if (baseDisplayName) {
                            baseTranslationCache[baseEnTrimmed] = baseDisplayName;
                        } else {
                            if (baseTranslationCache[baseEnTrimmed]) {
                                baseDisplayName = baseTranslationCache[baseEnTrimmed];
                            } else {
                                // 中文尝试查手动字典，英文直接用英文名
                                if (IS_ZH) {
                                    baseDisplayName = MANUAL_TERMS_ZH[baseEnTrimmed.toLowerCase()] || baseEnTrimmed;
                                } else {
                                    baseDisplayName = baseEnTrimmed;
                                }
                            }
                        }

                        // 关键词
                        let keywords = keywordMap[char] || "";
                        if (!keywords) keywords = keywordMap[char.replace(/\uFE0F/g, '')] || "";
                        if (!keywords) {
                             const noSkin = char.replace(/[\u{1F3FB}-\u{1F3FF}]/gu, '');
                             keywords = keywordMap[noSkin] || "";
                        }

                        // 修饰词翻译
                        let qualDisplay = "";
                        if (qualEn) {
                            const parts = qualEn.split(', ');
                            const translatedParts = parts.map(p => {
                                const pLower = p.toLowerCase();
                                return componentMap[pLower] || p; 
                            });
                            // 中文用全角逗号，英文用半角
                            qualDisplay = translatedParts.join(IS_ZH ? '，' : ', ');
                        }

                        if (!rawData[cleanStatus]) rawData[cleanStatus] = {};
                        if (!rawData[cleanStatus][group]) rawData[cleanStatus][group] = {};
                        if (!rawData[cleanStatus][group][subgroup]) rawData[cleanStatus][group][subgroup] = {};
                        
                        if (!rawData[cleanStatus][group][subgroup][baseEnTrimmed]) {
                            rawData[cleanStatus][group][subgroup][baseEnTrimmed] = [];
                        }

                        rawData[cleanStatus][group][subgroup][baseEnTrimmed].push({
                            char: char,
                            name: baseDisplayName,
                            base: baseEnTrimmed,
                            qual: qualDisplay,
                            keywords: keywords
                        });
                    }
                });
            }

            function buildUI() {
                const statuses = Object.keys(rawData);
                if (!statuses.length) return;
                activeStatus = statuses.includes('fully-qualified') ? 'fully-qualified' : statuses[0];
                ui.filters.innerHTML = '';
                statuses.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = `chip ${s === activeStatus ? 'selected' : ''}`;
                    // 根据语言选择状态映射表
                    const map = IS_ZH ? STATUS_MAP_ZH : STATUS_MAP_EN;
                    btn.textContent = map[s] || s;
                    btn.onclick = () => changeStatus(s);
                    ui.filters.appendChild(btn);
                });
                renderMainContent();
            }

            function changeStatus(status) {
                activeStatus = status;
                Array.from(ui.filters.children).forEach((c, i) => {
                    const keys = Object.keys(rawData);
                    c.classList.toggle('selected', keys[i] === status);
                });
                renderMainContent();
            }

            function isMatch(item, query) {
                if (!query) return true;
                const q = query.toLowerCase();
                if (item.name && item.name.toLowerCase().includes(q)) return true;
                if (item.keywords && item.keywords.toLowerCase().includes(q)) return true;
                if (item.base && item.base.toLowerCase().includes(q)) return true;
                if (item.char.includes(q)) return true;
                return false;
            }

            function renderMainContent() {
                const searchQuery = ui.searchInput.value.trim();
                ui.content.innerHTML = '';
                ui.nav.innerHTML = '';
                if (!searchQuery) ui.main.scrollTop = 0;

                const groups = rawData[activeStatus] || {};
                const groupNames = Object.keys(groups);

                groupNames.forEach((gName, idx) => {
                    // 翻译组名
                    const translatedGroup = IS_ZH ? (GROUP_MAP_ZH[gName] || gName) : gName;
                    const iconName = ICON_MAP[gName] || 'category';
                    
                    const section = document.createElement('section');
                    section.className = 'group-section';
                    section.id = `sec-${idx}`;
                    section.innerHTML = `<div class="group-title">${translatedGroup}</div>`;

                    const subgroups = groups[gName];
                    let hasGroupItems = false;

                    Object.keys(subgroups).forEach(sgName => {
                        const baseMap = subgroups[sgName];
                        let grid = document.createElement('div');
                        grid.className = 'emoji-grid';
                        let hasGridItems = false;
                        let hasSubgroupItems = false;
                        const subgroupElements = [];

                        Object.keys(baseMap).forEach(base => {
                            const items = baseMap[base];
                            const matchedItems = items.filter(item => isMatch(item, searchQuery));
                            if (matchedItems.length === 0) return;

                            hasSubgroupItems = true;
                            hasGroupItems = true;

                            const baseItems = matchedItems.filter(i => !i.qual);
                            const variants = matchedItems.filter(i => i.qual);

                            if (items.length > 1 && matchedItems.length > 1) {
                                if (hasGridItems) { 
                                    subgroupElements.push(grid); 
                                    grid = document.createElement('div'); 
                                    grid.className = 'emoji-grid'; 
                                    hasGridItems = false; 
                                }
                                const card = document.createElement('div');
                                card.className = 'variant-card';
                                
                                if (baseItems.length > 0) {
                                    baseItems.forEach((item, i) => {
                                        const isLastBase = (i === baseItems.length - 1) && (variants.length > 0);
                                        card.appendChild(createBtn(item, isLastBase));
                                    });
                                }
                                variants.forEach(item => card.appendChild(createBtn(item, false)));
                                subgroupElements.push(card);
                            } else {
                                hasGridItems = true;
                                matchedItems.forEach(item => grid.appendChild(createBtn(item, false)));
                            }
                        });

                        if (hasGridItems) subgroupElements.push(grid);

                        if (hasSubgroupItems) {
                            const sgTitle = document.createElement('div');
                            sgTitle.className = 'subgroup-pill';
                            sgTitle.textContent = sgName.replace(/-/g, ' ');
                            section.appendChild(sgTitle);
                            subgroupElements.forEach(el => section.appendChild(el));
                        }
                    });

                    if (hasGroupItems) {
                        ui.content.appendChild(section);

                        const navItem = document.createElement('div');
                        navItem.className = `nav-item ${ui.nav.children.length === 0 ? 'active' : ''}`;
                        navItem.dataset.idx = idx;
                        navItem.innerHTML = `<div class="nav-icon-box"><span class="material-symbols-rounded">${iconName}</span></div>`;
                        
                        navItem.onclick = () => scrollToSection(idx);
                        navItem.addEventListener('touchstart', (e) => {
                            longPressTimer = setTimeout(() => { showTooltip(navItem, translatedGroup); }, 500);
                        });
                        navItem.addEventListener('touchend', () => {
                            clearTimeout(longPressTimer);
                            setTimeout(hideTooltip, 1000);
                        });
                        navItem.onmouseenter = () => showTooltip(navItem, translatedGroup);
                        navItem.onmouseleave = hideTooltip;

                        ui.nav.appendChild(navItem);
                    }
                });
                
                if (ui.content.children.length === 0) {
                    ui.content.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--sys-outline);">${UI_STRINGS.noResult}</div>`;
                } else {
                    initScrollSpy();
                }
            }

            function createBtn(item, isSeparator) {
                const btn = document.createElement('div');
                btn.className = 'emoji-btn' + (isSeparator ? ' separator' : '');
                btn.textContent = item.char;
                btn.onclick = (e) => { e.stopPropagation(); copyText(item.char); };
                const triggerTip = () => showTooltip(btn, item.name, item.qual);
                btn.onmouseenter = triggerTip;
                btn.onmouseleave = hideTooltip;
                btn.ontouchstart = () => triggerTip();
                btn.ontouchend = () => setTimeout(hideTooltip, 1000);
                return btn;
            }

            function copyText(char) {
                navigator.clipboard.writeText(char).then(() => showSnackbar(`${UI_STRINGS.copied} ${char}`))
                .catch(() => {
                    const t = document.createElement('textarea');
                    t.value = char; document.body.appendChild(t);
                    t.select(); document.execCommand('copy'); document.body.removeChild(t);
                    showSnackbar(`${UI_STRINGS.copied} ${char}`);
                });
            }

            function showSnackbar(msg) {
                ui.snackbar.textContent = msg;
                ui.snackbar.classList.add('visible');
                setTimeout(() => ui.snackbar.classList.remove('visible'), 2500);
            }

            function showTooltip(el, base, qual) {
                if (tooltipTimeout) clearTimeout(tooltipTimeout);
                ui.tooltip.innerHTML = `<span class="tt-main">${base}</span>${qual ? '<span class="tt-sub">'+qual+'</span>' : ''}`;
                const rect = el.getBoundingClientRect();
                const tipRect = ui.tooltip.getBoundingClientRect();
                const gap = 12;
                let left = rect.left + (rect.width/2) - (tipRect.width/2);
                left = Math.max(10, Math.min(window.innerWidth - tipRect.width - 10, left));
                let top = rect.top - tipRect.height - gap;
                if (top < 10) top = rect.bottom + gap;
                ui.tooltip.style.left = `${left}px`;
                ui.tooltip.style.top = `${top}px`;
                ui.tooltip.classList.add('visible');
            }

            function hideTooltip() { ui.tooltip.classList.remove('visible'); }

            function scrollToSection(idx) {
                isScrolling = true;
                const target = document.getElementById(`sec-${idx}`);
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const activeBtn = document.querySelector(`.nav-item[data-idx="${idx}"]`);
                if (activeBtn) { activeBtn.classList.add('active'); activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }
                if (target) { const offset = target.offsetTop - 120; ui.main.scrollTo({ top: offset, behavior: 'smooth' }); }
                setTimeout(() => isScrolling = false, 800);
            }

            function initScrollSpy() {
                ui.main.onscroll = () => {
                    if (isScrolling) return;
                    let activeIdx = -1;
                    const scrollY = ui.main.scrollTop + 180;
                    const sections = document.querySelectorAll('.group-section');
                    for (const section of sections) {
                        if (section.offsetTop <= scrollY) {
                            activeIdx = parseInt(section.id.split('-')[1]);
                        } else {
                            break;
                        }
                    }
                    if (activeIdx !== -1) {
                        document.querySelectorAll('.nav-item').forEach(n => {
                            const isActive = parseInt(n.dataset.idx) === activeIdx;
                            n.classList.toggle('active', isActive);
                            if (isActive) n.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                        });
                    }
                };
            }

            init();
        })();
    </script>
</body>
</html>
