<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Picker</title>
    <style>
        /* --- Design Tokens --- */
        :root {
            --sys-color-surface: #F8F9FF;
            --sys-color-surface-container: #EEF0F9;
            --sys-color-surface-container-high: #E3E6EF;
            --sys-color-on-surface: #191C20;
            --sys-color-on-surface-variant: #44474E;
            --sys-color-primary: #2D6187;
            --sys-color-on-primary: #FFFFFF;
            --sys-color-primary-container: #D2E4FF;
            --sys-color-on-primary-container: #001D34;
            --sys-color-outline-variant: #C4C6CF;
            --sys-color-inverse-surface: #2E3135;
            --sys-color-inverse-on-surface: #F0F0F3;
            
            --shape-corner-lg: 16px;
            font-family: system-ui, -apple-system, Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--sys-color-surface);
            color: var(--sys-color-on-surface);
            /* 使用 dvh 适配移动端动态地址栏 */
            height: 100vh;
            height: 100dvh; 
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- Loading --- */
        #loading-screen {
            position: fixed; inset: 0; z-index: 999;
            background: var(--sys-color-surface);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 20px; transition: opacity 0.3s;
        }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--sys-color-surface-container-high);
            border-top-color: var(--sys-color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Header --- */
        header {
            flex-shrink: 0;
            background: rgba(248, 249, 255, 0.9);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--sys-color-surface-container-high);
            padding: 12px 0; z-index: 10;
        }
        .tabs-container {
            display: flex; gap: 8px; padding: 0 16px;
            overflow-x: auto; scrollbar-width: none;
        }
        .filter-chip {
            height: 32px; padding: 0 16px;
            border: 1px solid var(--sys-color-outline-variant);
            border-radius: 8px; background: transparent;
            color: var(--sys-color-on-surface-variant);
            font-size: 14px; font-weight: 500;
            white-space: nowrap; cursor: pointer;
            transition: all 0.2s; user-select: none;
        }
        .filter-chip.selected {
            background: var(--sys-color-primary-container);
            color: var(--sys-color-on-primary-container);
            border-color: transparent;
        }

        /* --- Main Content --- */
        main {
            flex: 1; overflow-y: auto;
            /* 关键修改：大幅增加底部内边距，确保最后一行能完全滚出来 */
            padding: 0 16px 200px; 
            scroll-behavior: smooth;
        }
        
        .group-block { margin-top: 24px; }
        .group-title {
            font-size: 22px; font-weight: 400;
            color: var(--sys-color-on-surface);
            margin-bottom: 16px;
        }
        .subgroup-label {
            display: inline-block;
            font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--sys-color-primary);
            background: var(--sys-color-surface-container);
            padding: 6px 12px; border-radius: 8px;
            margin: 16px 0 8px;
        }

        .emoji-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        
        .variant-set {
            display: inline-flex; flex-wrap: wrap; align-items: center;
            background: var(--sys-color-surface-container);
            border-radius: var(--shape-corner-lg);
            padding: 6px; gap: 2px; margin: 4px 0 12px;
        }

        .emoji-btn {
            width: 44px; height: 44px; font-size: 26px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 10px;
            transition: transform 0.1s, background 0.2s;
            user-select: none; position: relative;
        }
        .emoji-btn:active { transform: scale(0.92); background: rgba(0,0,0,0.05); }
        .emoji-btn.base-separator { margin-right: 10px; }
        .emoji-btn.base-separator::after {
            content: ""; position: absolute;
            right: -7px; top: 8px; bottom: 8px;
            width: 1px; border-right: 2px dashed var(--sys-color-outline-variant);
        }

        /* --- Bottom Nav --- */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 80px;
            background: var(--sys-color-surface-container);
            display: flex; align-items: center;
            overflow-x: auto; padding: 0 12px; gap: 4px;
            z-index: 20; scrollbar-width: none;
            box-shadow: 0 -1px 0 var(--sys-color-surface-container-high);
        }
        .nav-item {
            min-width: 60px; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; opacity: 0.6; transition: 0.2s;
            color: var(--sys-color-on-surface-variant);
        }
        .nav-item.active { opacity: 1; color: var(--sys-color-on-surface); }
        .nav-icon-pill {
            height: 32px; padding: 0 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 4px; font-size: 12px; font-weight: 600;
            transition: 0.3s;
        }
        .nav-item.active .nav-icon-pill {
            background: var(--sys-color-primary-container);
            color: var(--sys-color-on-primary-container);
        }
        .nav-label { font-size: 11px; font-weight: 500; }

        /* --- Tooltip --- */
        #tooltip {
            position: fixed; z-index: 2000;
            background: #1E1E1E;
            color: #F2F2F2;
            padding: 10px 16px; 
            border-radius: 12px;
            font-size: 14px; 
            text-align: center;
            pointer-events: none; 
            opacity: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            
            /* 强制不换行 */
            white-space: nowrap;
            width: max-content;
            max-width: 92vw;
            
            transition: opacity 0.15s;
        }
        #tooltip.visible { opacity: 1; }
        .tt-base { display: block; font-weight: 700; margin-bottom: 2px; }
        .tt-qual { display: block; font-size: 12px; opacity: 0.8; font-weight: 400; }

        /* --- Snackbar --- */
        #snackbar {
            position: fixed; bottom: 90px; left: 50%;
            transform: translateX(-50%) scale(0.9);
            background: var(--sys-color-inverse-surface);
            color: var(--sys-color-inverse-on-surface);
            padding: 14px 24px; border-radius: 28px;
            font-size: 14px; font-weight: 500;
            opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 2001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #snackbar.visible { transform: translateX(-50%) scale(1); opacity: 1; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <div style="font-weight:500; color:var(--sys-color-primary)">正在加载 Emoji 数据...</div>
    </div>

    <header>
        <div class="tabs-container" id="status-tabs"></div>
    </header>

    <main id="main-content"></main>

    <nav id="bottom-nav"></nav>

    <div id="tooltip"></div>
    <div id="snackbar"></div>

    <script>
        (function() {
            'use strict';

            const TARGET_URL = 'https://www.unicode.org/Public/emoji/latest/emoji-test.txt';
            const PROXY_URL = 'https://api.codetabs.com/v1/proxy?quest=';
            
            let emojiData = {}; 
            let currentStatus = '';
            let isAutoScrolling = false;
            let tooltipTimer = null;

            const els = {
                loading: document.getElementById('loading-screen'),
                tabs: document.getElementById('status-tabs'),
                main: document.getElementById('main-content'),
                nav: document.getElementById('bottom-nav'),
                tooltip: document.getElementById('tooltip'),
                snackbar: document.getElementById('snackbar')
            };

            async function init() {
                try {
                    const response = await fetch(PROXY_URL + encodeURIComponent(TARGET_URL));
                    if (!response.ok) throw new Error('Network error');
                    const text = await response.text();
                    parseData(text);
                    renderApp();
                    els.loading.style.opacity = '0';
                    setTimeout(() => els.loading.style.display = 'none', 300);
                } catch (e) {
                    els.loading.innerHTML = `<div style="color:#B3261E;padding:20px;text-align:center">加载失败<br><span style="font-size:12px">${e.message}</span></div>`;
                }
            }

            function parseData(text) {
                const lines = text.split('\n');
                let curG = "Unknown", curSG = "Unknown";
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    if (line.startsWith('# group:')) curG = line.split(': ')[1].trim();
                    else if (line.startsWith('# subgroup:')) curSG = line.split(': ')[1].trim();
                    else if (!line.startsWith('#') && line.includes(';')) {
                        const parts = line.split(';');
                        const status = parts[1].split('#')[0].trim();
                        const comment = parts[1].split('#')[1].trim();
                        const firstSpace = comment.indexOf(' ');
                        const char = comment.substring(0, firstSpace);
                        const fullName = comment.substring(comment.indexOf(' ', firstSpace + 1) + 1).trim();
                        const nameParts = fullName.split(':');
                        const baseName = nameParts[0].trim();
                        const qualifier = nameParts.length > 1 ? nameParts.slice(1).join(':').trim() : "";

                        if (!emojiData[status]) emojiData[status] = {};
                        if (!emojiData[status][curG]) emojiData[status][curG] = {};
                        if (!emojiData[status][curG][curSG]) emojiData[status][curG][curSG] = {};
                        if (!emojiData[status][curG][curSG][baseName]) emojiData[status][curG][curSG][baseName] = [];
                        emojiData[status][curG][curSG][baseName].push({ char, base: baseName, qual: qualifier });
                    }
                });
            }

            function renderApp() {
                const statuses = Object.keys(emojiData);
                if (statuses.length === 0) return;
                currentStatus = statuses.includes('fully-qualified') ? 'fully-qualified' : statuses[0];
                els.tabs.innerHTML = '';
                statuses.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = `filter-chip ${s === currentStatus ? 'selected' : ''}`;
                    btn.textContent = s.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    btn.onclick = () => switchStatus(s);
                    els.tabs.appendChild(btn);
                });
                renderContent();
            }

            function switchStatus(status) {
                currentStatus = status;
                Array.from(els.tabs.children).forEach(btn => {
                    btn.classList.toggle('selected', btn.textContent.toLowerCase().replace(/ /g, '-') === status);
                });
                renderContent();
            }

            function renderContent() {
                els.main.innerHTML = '';
                els.nav.innerHTML = '';
                els.main.scrollTop = 0;
                const groups = emojiData[currentStatus] || {};
                const groupNames = Object.keys(groups);

                groupNames.forEach((gName, idx) => {
                    const navItem = document.createElement('div');
                    navItem.className = `nav-item ${idx === 0 ? 'active' : ''}`;
                    navItem.dataset.idx = idx;
                    const shortLabel = gName.split(' ')[0].replace('&','').trim();
                    navItem.innerHTML = `<div class="nav-icon-pill">${shortLabel.substring(0,2).toUpperCase()}</div><span class="nav-label">${shortLabel}</span>`;
                    navItem.onclick = () => scrollToGroup(idx);
                    els.nav.appendChild(navItem);

                    const gBlock = document.createElement('div');
                    gBlock.className = 'group-block';
                    gBlock.id = `g-${idx}`;
                    gBlock.innerHTML = `<div class="group-title">${gName}</div>`;

                    const subgroups = groups[gName];
                    Object.keys(subgroups).forEach(sgName => {
                        const sgLabel = document.createElement('div');
                        sgLabel.className = 'subgroup-label';
                        sgLabel.textContent = sgName;
                        gBlock.appendChild(sgLabel);

                        const baseMap = subgroups[sgName];
                        let looseRow = document.createElement('div');
                        looseRow.className = 'emoji-grid';
                        let hasLoose = false;

                        Object.keys(baseMap).forEach(baseName => {
                            const items = baseMap[baseName];
                            const baseItems = items.filter(i => !i.qual);
                            const variantItems = items.filter(i => i.qual);

                            if (items.length > 1 && baseItems.length > 0 && variantItems.length > 0) {
                                if (hasLoose) { gBlock.appendChild(looseRow); looseRow = document.createElement('div'); looseRow.className = 'emoji-grid'; hasLoose = false; }
                                const setBox = document.createElement('div');
                                setBox.className = 'variant-set';
                                baseItems.forEach((obj, i) => setBox.appendChild(createEmojiBtn(obj, i === baseItems.length - 1)));
                                variantItems.forEach(obj => setBox.appendChild(createEmojiBtn(obj, false)));
                                gBlock.appendChild(setBox);
                            } else {
                                hasLoose = true;
                                items.forEach(obj => looseRow.appendChild(createEmojiBtn(obj, false)));
                            }
                        });
                        if (hasLoose) gBlock.appendChild(looseRow);
                    });
                    els.main.appendChild(gBlock);
                });
                setupScrollSpy(groupNames.length);
            }

            function createEmojiBtn(obj, isSeparator) {
                const btn = document.createElement('div');
                btn.className = 'emoji-btn' + (isSeparator ? ' base-separator' : '');
                btn.textContent = obj.char;
                btn.onclick = (e) => { e.stopPropagation(); copyToClipboard(obj.char); };
                
                const trigger = () => showTooltip(btn, obj.base, obj.qual);
                btn.onmouseenter = trigger;
                btn.onmouseleave = hideTooltip;
                btn.ontouchstart = (e) => { trigger(); }; 
                btn.ontouchend = () => { setTimeout(hideTooltip, 1500); };

                return btn;
            }

            function copyToClipboard(char) {
                navigator.clipboard.writeText(char).then(() => showSnackbar(`已复制 ${char}`))
                .catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = char; document.body.appendChild(ta);
                    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                    showSnackbar(`已复制 ${char}`);
                });
            }

            function showSnackbar(msg) {
                els.snackbar.textContent = msg;
                els.snackbar.classList.add('visible');
                setTimeout(() => els.snackbar.classList.remove('visible'), 2000);
            }

            function showTooltip(el, base, qual) {
                if (tooltipTimer) clearTimeout(tooltipTimer);
                
                els.tooltip.innerHTML = `<span class="tt-base">${base}</span>${qual ? '<span class="tt-qual">'+qual+'</span>' : ''}`;
                
                const rect = el.getBoundingClientRect();
                const tipRect = els.tooltip.getBoundingClientRect();
                const screenW = window.innerWidth;
                const gap = 14;

                // 水平定位：居中，但限制在屏幕内
                let left = rect.left + (rect.width / 2) - (tipRect.width / 2);
                if (left < 10) left = 10;
                if (left + tipRect.width > screenW - 10) left = screenW - tipRect.width - 10;

                // 垂直定位：优先上方，空间不足则下方
                let top = rect.top - tipRect.height - gap;
                if (top < 50) {
                    top = rect.bottom + gap;
                }

                els.tooltip.style.left = left + 'px';
                els.tooltip.style.top = top + 'px';
                els.tooltip.classList.add('visible');
            }

            function hideTooltip() {
                els.tooltip.classList.remove('visible');
            }

            function scrollToGroup(idx) {
                isAutoScrolling = true;
                const target = document.getElementById(`g-${idx}`);
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const activeNav = document.querySelector(`.nav-item[data-idx="${idx}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                    activeNav.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
                if (target) els.main.scrollTo({ top: target.offsetTop - 16, behavior: 'smooth' });
                setTimeout(() => isAutoScrolling = false, 800);
            }

            function setupScrollSpy(count) {
                els.main.onscroll = () => {
                    if (isAutoScrolling) return;
                    let activeIdx = 0;
                    for (let i = 0; i < count; i++) {
                        const el = document.getElementById(`g-${i}`);
                        if (el.offsetTop <= els.main.scrollTop + 150) activeIdx = i; else break;
                    }
                    document.querySelectorAll('.nav-item').forEach((n, i) => {
                        const isActive = i === activeIdx;
                        n.classList.toggle('active', isActive);
                        if (isActive) n.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    });
                };
            }

            init();
        })();
    </script>
</body>
</html>
