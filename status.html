<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 字体 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" />
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <title>3D坦克服务器状态页面</title>
    <style>
        :root {
            --md-sys-color-background: rgb(32, 48, 64);
            --md-sys-color-background-end: rgb(3, 8, 13);
            --md-sys-color-primary: #76ff33;
            --md-sys-color-on-primary: #001926;
            --md-sys-color-surface: rgba(255, 255, 255, 0.08);
            --md-sys-color-on-surface: #ffffff;
            --md-sys-color-on-surface-variant: #c4c7c5;
            --state-searching: #FF6666;
            
            --md-sys-shape-corner-large: 28px;
            --md-sys-shape-corner-full: 999px;
        }

        body {
            background: radial-gradient(var(--md-sys-color-background) 0%, var(--md-sys-color-background-end) 100%);
            font-family: 'Rubik', 'M PLUS 1p', sans-serif;
            color: var(--md-sys-color-on-surface);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            box-sizing: border-box;
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 10;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--md-sys-shape-corner-full);
            transition: background-color 0.2s;
        }

        .btn-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        #backButton { display: none; }

        /* --- 高级环形计时器样式 --- */
        .circular-timer {
            position: relative;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-svg {
            transform: rotate(-90deg); /* 从顶部开始 */
            width: 100%;
            height: 100%;
        }

        .timer-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 4;
        }

        .timer-circle-fg {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            /* 2 * PI * r (r=20) ≈ 125.6 */
            stroke-dasharray: 125.6; 
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.1s linear, stroke 0.3s ease;
        }

        .timer-content {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Rubik', sans-serif;
            font-weight: 500;
            font-size: 12px;
            font-feature-settings: "tnum"; /* 等宽数字，防止跳动 */
        }

        /* 状态颜色定义 */
        .timer-searching .timer-circle-fg { stroke: var(--state-searching); }
        .timer-searching .timer-content { color: var(--state-searching); }
        
        .timer-stable .timer-circle-fg { stroke: var(--md-sys-color-primary); }
        .timer-stable .timer-content { color: var(--md-sys-color-primary); }

        /* 寻找模式动画：无限旋转 */
        .timer-searching .timer-svg {
            animation: rotate-ring 1s linear infinite;
        }
        /* 寻找模式下，圆环缺口固定 */
        .timer-searching .timer-circle-fg {
            stroke-dashoffset: 80; 
            transition: none;
        }

        @keyframes rotate-ring {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- 主要内容 --- */
        .container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.6s ease-out;
        }

        .status-card {
            background: var(--md-sys-color-surface);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--md-elevation-2);
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        .status-card h1 {
            margin: 0 0 32px 0;
            font-size: 24px;
            font-weight: 500;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            transition: transform 0.2s;
        }
        
        .stat-item:hover {
            transform: scale(1.02);
            background: rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-family: 'Rubik', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(118, 255, 51, 0.3);
        }

        .stat-label {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (min-width: 600px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .status-card { max-width: 700px; }
        }
        
        * { -webkit-tap-highlight-color: transparent; outline: none; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button id="backButton" class="btn-icon" onclick="goBack()" title="返回">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
        </div>
        <div class="header-right">
            <!-- 高级环形计时器 -->
            <div id="circularTimer" class="circular-timer timer-searching">
                <svg class="timer-svg" viewBox="0 0 48 48">
                    <circle class="timer-circle-bg" cx="24" cy="24" r="20"></circle>
                    <circle id="progressRing" class="timer-circle-fg" cx="24" cy="24" r="20"></circle>
                </svg>
                <div id="timerContent" class="timer-content">
                    <span class="material-symbols-rounded" style="font-size: 20px;">radar</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="status-card">
            <h1>国服</h1>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span id="onlineCount" class="stat-value">--</span>
                    <span class="stat-label">在线</span>
                </div>
                
                <div class="stat-item">
                    <span id="inbattlesCount" class="stat-value">--</span>
                    <span class="stat-label">战斗中</span>
                </div>
                
                <div class="stat-item">
                    <span id="my4399ComCount" class="stat-value">--</span>
                    <span class="stat-label">4399</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let nextFetchTimeout = null;
        let lastDataSignature = null;
        let isStableMode = false; 
        
        // 动画循环相关变量
        let animationFrameId;
        let endTime = 0;
        const TOTAL_DURATION = 5000; // 5秒
        const CIRCUMFERENCE = 125.6; // 2 * PI * 20

        // 切换 UI 模式 (寻找中 vs 倒计时)
        function setTimerMode(mode) {
            const container = document.getElementById('circularTimer');
            const content = document.getElementById('timerContent');
            const ring = document.getElementById('progressRing');

            if (mode === 'searching') {
                container.className = 'circular-timer timer-searching';
                // 显示雷达图标
                content.innerHTML = '<span class="material-symbols-rounded" style="font-size: 20px;">radar</span>';
                // 停止JS动画，依靠CSS旋转
                cancelAnimationFrame(animationFrameId);
            } else {
                container.className = 'circular-timer timer-stable';
                // 重置圆环
                ring.style.strokeDashoffset = 0;
            }
        }

        // 更新平滑倒计时动画
        function updateProgress() {
            const now = Date.now();
            const remaining = endTime - now;
            
            if (remaining <= 0) {
                document.getElementById('timerContent').innerText = "0.0";
                document.getElementById('progressRing').style.strokeDashoffset = CIRCUMFERENCE;
                return; 
            }

            // 计算进度 (0 ~ 1)
            const percent = remaining / TOTAL_DURATION;
            // 计算 offset (全满是0，全空是125.6)
            const offset = CIRCUMFERENCE - (percent * CIRCUMFERENCE);

            // 更新圆环
            document.getElementById('progressRing').style.strokeDashoffset = offset;
            
            // 更新文字 (保留1位小数，看起来更科技感)
            document.getElementById('timerContent').innerText = (remaining / 1000).toFixed(1);

            animationFrameId = requestAnimationFrame(updateProgress);
        }

        function fetchBalancerStats() {
            const timestamp = Date.now();
            const url = `https://balancer.3dtank.com/balancer?t=${timestamp}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let totalInbattles = 0;
                    let totalOnline = 0;
                    let totalMy4399Com = 0;

                    Object.values(data.nodes).forEach(node => {
                        totalInbattles += node.inbattles || 0;
                        totalOnline += node.online || 0;
                        totalMy4399Com += node.partners && node.partners.my_4399_com ? node.partners.my_4399_com : 0;
                    });

                    const my4399ComCount = totalMy4399Com || 0;
                    const currentSignature = `${totalOnline}-${totalInbattles}-${my4399ComCount}`;

                    // 更新 DOM
                    document.getElementById('inbattlesCount').innerText = totalInbattles;
                    document.getElementById('onlineCount').innerText = totalOnline;
                    document.getElementById('my4399ComCount').innerText = my4399ComCount;

                    // 逻辑核心
                    if (lastDataSignature !== null && currentSignature !== lastDataSignature) {
                        isStableMode = true;
                    }

                    lastDataSignature = currentSignature;
                    planNextFetch();
                })
                .catch(error => {
                    console.error('Error:', error);
                    setTimeout(fetchBalancerStats, 1000);
                });
        }

        function planNextFetch() {
            if (nextFetchTimeout) clearTimeout(nextFetchTimeout);
            cancelAnimationFrame(animationFrameId);

            if (!isStableMode) {
                // --- 模式: 寻找刷新点 ---
                setTimerMode('searching');
                // 极速刷新 (0延时)
                nextFetchTimeout = setTimeout(fetchBalancerStats, 0);
            } else {
                // --- 模式: 稳定倒计时 (5秒) ---
                setTimerMode('stable');
                
                // 设定结束时间
                endTime = Date.now() + TOTAL_DURATION;
                // 启动视觉动画循环
                updateProgress();

                // 设定实际请求
                nextFetchTimeout = setTimeout(fetchBalancerStats, TOTAL_DURATION);
            }
        }

        function goBack() {
            if (document.referrer.includes("testanki1.github.io")) {
                window.history.back();
            }
        }

        if (document.referrer.includes("testanki1.github.io")) {
            document.getElementById("backButton").style.display = "inline-flex";
        }

        // 启动
        fetchBalancerStats();

    </script>
</body>
</html>
